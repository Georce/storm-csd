#!/bin/bash

set -eux

source=storm.properties
nimbus_list=nimbus.list
target=storm.yaml
orig=.storm.yaml.orig
stamp=.stamp-config

function properties_yaml {
    while read line; do
        if [[ ! $line =~ ([a-z0-9._]+)=(.*) ]]; then
            echo "Ignoring line: $line" >&2
            continue
        fi
        local k="${BASH_REMATCH[1]}"
        local v="${BASH_REMATCH[2]}"

        case "$k" in
        log_dir)
            k=storm.log.dir
            ;;
        supervisor.slots.ports)
            local ports=$(tr , ' ' <<< "$v")
            v=$'\n'
            for port in $ports; do
                v+=" - $port"$'\n'
            done
            ;;
        esac

        printf '%s: %s\n' "$k" "$v"
    done < "$source"
}

function zookeeper_yaml {
    echo 'storm.zookeeper.servers:'
    local x host port oldport=
    for x in $ZK_QUORUM; do
        # XXX is this space separated?
        read host port < <(tr : ' ' <<< "$x")
        echo " - $host"
        if [[ -n $oldport && $port != $oldport ]]; then
            echo "Zookeeper ensemble must all use the same port: $ZK_QUORUM" >&2
            return 1
        fi
        oldport=$port
    done

    echo "storm.zookeeper.port: $port"
}

function nimbus_yaml {
    nimbus=$(cut -d : -f 1 < "$nimbus_list" | head -n 1)
    if [[ -z $nimbus ]]; then
        echo "Could not determine nimbus.host" >&2
        return 1
    fi
    echo "nimbus.host: $nimbus"
}

function to_yaml {
    properties_yaml
    zookeeper_yaml
    nimbus_yaml
}

# Operate idempotently
if [[ -f "$stamp" ]]; then
    exit 0
fi

mv "$target" "$orig"
to_yaml > "$target"
cat "$orig" >> "$target"

printf $'#\n# storm.yaml follows:\n#\n'
cat "$target"
printf $'#\n#\n#\n'

touch "$stamp"
